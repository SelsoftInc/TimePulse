#!/usr/bin/env node

/**
 * Setup Encryption Keys
 * This script creates the necessary .env files with matching encryption keys
 */

const fs = require('fs');
const path = require('path');

// The encryption key from the user
const ENCRYPTION_KEY = 'fc9e7f980be3381a0fd4395aa195104ceb33bcc369fa2c764de9a8fbe1e9f636';

console.log('üîê Setting up encryption keys...\n');

// 1. Update server .env file
const serverEnvPath = path.join(__dirname, 'server', '.env');
console.log('üìù Checking server .env file...');

if (fs.existsSync(serverEnvPath)) {
  let serverEnv = fs.readFileSync(serverEnvPath, 'utf8');
  
  // Check if ENCRYPTION_KEY exists
  if (serverEnv.includes('ENCRYPTION_KEY=')) {
    // Update existing key
    serverEnv = serverEnv.replace(
      /ENCRYPTION_KEY=.*/,
      `ENCRYPTION_KEY=${ENCRYPTION_KEY}`
    );
    console.log('‚úÖ Updated ENCRYPTION_KEY in server/.env');
  } else {
    // Add new key
    serverEnv += `\n# Encryption Key for API Responses\nENCRYPTION_KEY=${ENCRYPTION_KEY}\n`;
    console.log('‚úÖ Added ENCRYPTION_KEY to server/.env');
  }
  
  fs.writeFileSync(serverEnvPath, serverEnv);
} else {
  console.log('‚ö†Ô∏è  server/.env not found, creating from template...');
  const templatePath = path.join(__dirname, 'server', '.env.template');
  if (fs.existsSync(templatePath)) {
    let template = fs.readFileSync(templatePath, 'utf8');
    template = template.replace(
      /ENCRYPTION_KEY=.*/,
      `ENCRYPTION_KEY=${ENCRYPTION_KEY}`
    );
    fs.writeFileSync(serverEnvPath, template);
    console.log('‚úÖ Created server/.env with encryption key');
  }
}

// 2. Create/Update frontend .env.local file
const frontendEnvPath = path.join(__dirname, 'nextjs-app', '.env.local');
console.log('\nüìù Checking frontend .env.local file...');

const frontendEnvContent = `# Frontend Environment Variables
# This file is auto-generated by setup-encryption-keys.js

# Encryption key for decrypting API responses
# MUST match the backend ENCRYPTION_KEY
NEXT_PUBLIC_ENCRYPTION_KEY=${ENCRYPTION_KEY}

# API Base URL
NEXT_PUBLIC_API_URL=http://localhost:5001

# Note: This file is gitignored and safe for local development
`;

fs.writeFileSync(frontendEnvPath, frontendEnvContent);
console.log('‚úÖ Created/Updated nextjs-app/.env.local with encryption key');

console.log('\nüéâ Encryption keys setup complete!\n');
console.log('üìã Summary:');
console.log('   - Server ENCRYPTION_KEY: Set');
console.log('   - Frontend NEXT_PUBLIC_ENCRYPTION_KEY: Set');
console.log('   - Both keys match: ‚úÖ\n');
console.log('üöÄ Next steps:');
console.log('   1. Restart the backend server: cd server && npm start');
console.log('   2. Restart the frontend: cd nextjs-app && npm run dev');
console.log('   3. Try logging in again\n');
